<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <title>Kumpee Bangkok ‚Ä¢ Webboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="color-scheme" content="light dark" />
  <style>
    :root{ --bg:#f7f8fb; --card:#fff; --border:#e5e7eb; --text:#0f172a; --muted:#6b7280; --ring:#818cf8; --acc1:#6366f1; --acc2:#22c55e; --shadow:0 10px 24px rgba(2,6,23,.12) }
    @media (prefers-color-scheme: dark){
      :root{ --bg:#0b1220; --card:#0f172a; --border:#1f2937; --text:#e5e7ee; --muted:#9aa3b2; --shadow:0 10px 24px rgba(0,0,0,.45) }
    }
    *{box-sizing:border-box}
    body{
      margin:0; font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Arial; color:var(--text);
      background:
        radial-gradient(900px 500px at -10% -10%, rgba(99,102,241,.16), transparent 60%),
        radial-gradient(900px 500px at 110% 0%, rgba(34,197,94,.16), transparent 60%),
        var(--bg)
    }
    a{color:inherit}
    .hero{position:sticky; top:0; z-index:10; backdrop-filter: blur(8px); border-bottom:1px solid var(--border); background:linear-gradient(135deg, rgba(99,102,241,.10), rgba(34,197,94,.08)), color-mix(in srgb, #fff 85%, transparent)}
    .hero-inner{max-width:1000px; margin:0 auto; padding:14px 16px; display:flex; align-items:center; gap:12px}
    .logo{display:grid; place-items:center; width:42px; height:42px; border-radius:12px; color:#fff; background:linear-gradient(145deg, var(--acc1), var(--acc2)); box-shadow:var(--shadow)}
    .brand{flex:1}
    .brand h1{margin:0; font-size:18px}
    .brand p{margin:0; color:var(--muted); font-size:12px}
    .wrap{max-width:1000px; margin:18px auto; padding:0 16px; display:grid; gap:16px}
    @media (min-width: 900px){ .wrap{grid-template-columns: 2fr 1fr} }
    .card{background:var(--card); border:1px solid var(--border); border-radius:14px; padding:16px; box-shadow:var(--shadow)}
    .card h3{margin:0 0 10px}
    label{font-size:12px; color:var(--muted); display:block; margin-bottom:6px}
    input, textarea{width:100%; padding:10px 12px; border:1px solid var(--border); border-radius:10px; background:transparent; color:inherit; outline:none}
    input:focus, textarea:focus{border-color:var(--ring); box-shadow:0 0 0 3px color-mix(in srgb, var(--ring) 30%, transparent)}
    .row{display:flex; align-items:center; gap:8px; flex-wrap:wrap}
    .btn{appearance:none; border:1px solid var(--border); background:#f8fafc; padding:8px 12px; border-radius:10px; cursor:pointer; font-weight:600}
    .btn:disabled{opacity:.5; cursor:not-allowed}
    .btn-primary{background:linear-gradient(135deg, var(--acc1), var(--acc2)); color:#fff; border:none}
    .btn-ghost{background:transparent}
    .hint{color:var(--muted); font-size:12px}
    .pill{display:inline-block; padding:.18rem .5rem; border:1px solid var(--border); border-radius:999px; font-size:12px; color:var(--muted)}
    .list{display:grid; gap:12px}
    .thread{display:grid; grid-template-columns:auto 1fr auto; gap:10px; align-items:start}
    .votes{display:grid; place-items:center; padding:8px; border:1px solid var(--border); border-radius:10px; min-width:56px}
    .title{font-weight:700}
    .meta{color:var(--muted); font-size:12px}
    .searchbar{display:flex; gap:8px}
    .searchbar input{flex:1}
    .toast{position:fixed; right:16px; bottom:16px; display:grid; gap:8px; z-index:50}
    .t{padding:10px 12px; border-radius:12px; background:#0b1220; color:#eef2ff; border:1px solid #293249; box-shadow:var(--shadow)}
    .t.ok{background:#052816; color:#ecfdf5}
    .t.err{background:#2a0b0b; color:#fee2e2}
    .skeleton{height:64px; border-radius:12px; background:linear-gradient(90deg, rgba(148,163,184,.16), rgba(148,163,184,.06), rgba(148,163,184,.16)); background-size:200% 100%; animation:shim 1.2s infinite}
    @keyframes shim{0%{background-position:200% 0}100%{background-position:-200% 0}}
    .modalWrap{position:fixed; inset:0; display:none; place-items:center; background:rgba(15,23,42,.4); z-index:100}
    .modalWrap.show{display:grid}
    .modal{background:var(--card); border:1px solid var(--border); border-radius:14px; padding:16px; width:90%; max-width:360px; box-shadow:var(--shadow)}
    .modal h4{margin:0 0 10px}
  </style>
</head>
<body>
  <header class="hero">
    <div class="hero-inner">
      <div class="logo">KB</div>
      <div class="brand">
        <h1>Kumpee Bangkok ‚Ä¢ Webboard</h1>
        <p>‡πÇ‡∏Æ‡∏™‡∏ï‡πå API ‡∏ö‡∏ô EC2/Cloud9 ‚Ä¢ ‡πÄ‡∏Å‡πá‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏õ‡πá‡∏ô JSON ‡∏ö‡∏ô S3 (private)</p>
      </div>
      <div class="row">
        <button id="openSignup" class="btn">Sign up</button>
        <button id="openLogin"  class="btn">Login</button>
        <button id="logoutBtn"  class="btn btn-ghost" style="display:none">Logout</button>
        <span id="who" class="hint" aria-live="polite"></span>
      </div>
    </div>
  </header>

  <main class="wrap">
    <section>
      <div class="card">
        <h3>üîé ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°</h3>
        <div class="searchbar">
          <input id="q" placeholder="‡πÄ‡∏ä‡πà‡∏ô: ‡∏ß‡∏µ‡∏ã‡πà‡∏≤‡∏ó‡∏µ‡πà‡πÄ‡∏Ç‡∏ï‡∏ö‡∏≤‡∏á‡∏£‡∏±‡∏Å / ‡∏°.‡∏Å‡∏£‡∏∏‡∏á‡πÄ‡∏ó‡∏û ‡∏´‡∏≠‡∏û‡∏±‡∏Å" />
          <button id="doSearch" class="btn btn-primary">Search</button>
        </div>
        <div class="hint" style="margin-top:6px">‡∏à‡∏±‡∏î‡∏≠‡∏±‡∏ô‡∏î‡∏±‡∏ö‡∏î‡πâ‡∏ß‡∏¢ keyword + TF + fuzzy (prefix & edit‚â§1) + title boost</div>
        <div id="results" class="list" style="margin-top:12px"></div>
      </div>

      <div class="card">
        <h3>üßµ ‡∏Å‡∏£‡∏∞‡∏ó‡∏π‡πâ‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î</h3>
        <div class="row">
          <button id="latest" class="btn">‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</button>
          <span id="latestCount" class="hint"></span>
        </div>
        <div id="latestOut" class="list" style="margin-top:12px"></div>
      </div>
    </section>

    <aside>
      <div class="card">
        <h3>‚ùì ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Å‡∏£‡∏∞‡∏ó‡∏π‡πâ‡πÉ‡∏´‡∏°‡πà</h3>
        <label class="hint">‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠</label>
        <input id="title" placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏™‡∏±‡πâ‡∏ô ‡πÜ" />
        <div style="height:8px"></div>
        <label class="hint">‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î</label>
        <textarea id="body" rows="5" placeholder="‡πÄ‡∏•‡πà‡∏≤‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î ‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà ‡πÄ‡∏ß‡∏•‡∏≤ ‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Ç‡πâ‡∏≠‡∏á ‡∏Ø‡∏•‡∏Ø"></textarea>
        <div class="row" style="margin-top:10px">
          <button id="ask" class="btn btn-primary">‡πÇ‡∏û‡∏™‡∏ï‡πå‡∏Å‡∏£‡∏∞‡∏ó‡∏π‡πâ</button>
          <span class="hint">‡∏ï‡πâ‡∏≠‡∏á Login ‡∏Å‡πà‡∏≠‡∏ô</span>
        </div>
        <div id="askOut" class="hint" style="margin-top:8px"></div>
      </div>

      <div class="card">
        <h3>üí¨ ‡∏ï‡∏≠‡∏ö‡∏Å‡∏£‡∏∞‡∏ó‡∏π‡πâ</h3>
        <label class="hint">Question ID</label>
        <input id="qid" placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡πÑ‡∏≠‡∏î‡∏µ‡∏Å‡∏£‡∏∞‡∏ó‡∏π‡πâ" />
        <div style="height:8px"></div>
        <label class="hint">‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì</label>
        <textarea id="ans" rows="4" placeholder="‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢‡πÉ‡∏´‡πâ‡∏ä‡∏±‡∏î‡πÄ‡∏à‡∏ô ‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÅ‡∏´‡∏•‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ñ‡πâ‡∏≤‡∏°‡∏µ"></textarea>
        <div class="row" style="margin-top:10px">
          <button id="answer" class="btn btn-primary">‡πÇ‡∏û‡∏™‡∏ï‡πå‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö</button>
        </div>
        <div id="ansOut" class="hint" style="margin-top:8px"></div>
      </div>
    </aside>
  </main>

  <div id="authModals" class="modalWrap">
    <div id="signupCard" class="modal" style="display:none">
      <h4>‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ö‡∏±‡∏ç‡∏ä‡∏µ</h4>
      <label class="hint">Username</label>
      <input id="su_user" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ (a-z 0-9 . _ -)" />
      <div style="height:8px"></div>
      <label class="hint">Password</label>
      <input id="su_pass" type="password" placeholder="‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 6 ‡∏ï‡∏±‡∏ß‡∏≠‡∏±‡∏Å‡∏©‡∏£" />
      <div class="row" style="margin-top:10px">
        <button id="doSignup" class="btn btn-primary">Sign up</button>
        <button id="cancelSignup" class="btn">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
      </div>
      <div id="signupError" class="hint" style="margin-top:8px; color:#ef4444"></div>
    </div>

    <div id="loginCard" class="modal" style="display:none">
      <h4>‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</h4>
      <label class="hint">Username</label>
      <input id="li_user" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ" />
      <div style="height:8px"></div>
      <label class="hint">Password</label>
      <input id="li_pass" type="password" placeholder="‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô" />
      <div class="row" style="margin-top:10px">
        <button id="doLogin" class="btn btn-primary">Login</button>
        <button id="cancelLogin" class="btn">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
      </div>
      <div id="loginError" class="hint" style="margin-top:8px; color:#ef4444"></div>
    </div>
  </div>

  <div class="toast" id="toast" aria-live="polite" aria-atomic="true"></div>

<script>
/* =======================
   Kumpee Bangkok Webboard ‚Äî Frontend (Fixed)
   Connects to your AWS API endpoints
   ======================= */

const api = window.location.origin; // same-origin

// ===== Utilities =====
function $(id){ return document.getElementById(id); }
function toast(msg, kind='ok'){
  const t=document.createElement('div'); t.className=`t ${kind}`; t.textContent=msg;
  document.getElementById('toast').appendChild(t); setTimeout(()=>t.remove(),2800);
}
function skeleton(parent){ const s=document.createElement('div'); s.className='skeleton'; parent.appendChild(s); return s; }
function escapeHtml(s){ return String(s).replace(/[&<>"']/g, m=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"}[m])); }

// ===== Session =====
function getSession(){ 
  const data = localStorage.getItem('kb_session');
  if(!data) return null;
  // Handle both string and JSON formats
  try {
    const parsed = JSON.parse(data);
    return typeof parsed === 'string' ? parsed : (parsed?.username || null);
  } catch(e) {
    // If it's not JSON, it's a plain string username
    return data;
  }
}

function setSession(u){ 
  if(u) {
    // Always store as plain string username
    const username = typeof u === 'string' ? u : u?.username;
    if(username) localStorage.setItem('kb_session', username);
  } else {
    localStorage.removeItem('kb_session');
  }
}

function authHeader(){ 
  const username = getSession();
  return username ? { 'X-User': username } : {}; 
}

function renderAuth(){
  const username = getSession();
  $('who').textContent = username ? `Signed in as @${username}` : '';
  $('logoutBtn').style.display = username ? 'inline-block' : 'none';
  $('openSignup').style.display = username ? 'none' : 'inline-block';
  $('openLogin').style.display  = username ? 'none' : 'inline-block';
}

// ===== Auth (call server) =====
async function signup(username, password){
  if(!username || !password) throw new Error('username/password ‡∏ï‡πâ‡∏≠‡∏á‡πÑ‡∏°‡πà‡∏ß‡πà‡∏≤‡∏á');
  // Note: Your API doesn't have /auth/signup endpoint
  // Storing credentials locally for demo
  const users = JSON.parse(localStorage.getItem('kb_users') || '{}');
  if(users[username.toLowerCase()]) throw new Error('Username already exists');
  users[username.toLowerCase()] = { username, password };
  localStorage.setItem('kb_users', JSON.stringify(users));
  setSession(username);
  return { ok: true, user: { username } };
}

async function login(username, password){
  if(!username || !password) throw new Error('username/password ‡∏ï‡πâ‡∏≠‡∏á‡πÑ‡∏°‡πà‡∏ß‡πà‡∏≤‡∏á');
  // Note: Your API doesn't have /auth/login endpoint
  // Checking credentials locally
  const users = JSON.parse(localStorage.getItem('kb_users') || '{}');
  const user = users[username.toLowerCase()];
  if(!user || user.password !== password) throw new Error('Invalid username or password');
  setSession(username);
  return { ok: true, user: { username } };
}

function logout(){ setSession(null); }

// ===== Questions helpers =====
async function fetchQuestions(){
  try {
    const r = await fetch(api + '/questions');
    if(!r.ok) {
      const errText = await r.text().catch(() => '');
      console.error('API Error:', r.status, errText);
      throw new Error('API error ' + r.status + ': ' + (errText || 'Server error'));
    }
    const j = await r.json().catch((e)=>{
      console.error('JSON parse error:', e);
      return [];
    });
    // API returns array directly, not wrapped in {ok, questions}
    const arr = Array.isArray(j) ? j : [];
    return arr; // already sorted by API (reversed)
  } catch(e) {
    console.error('fetchQuestions error:', e);
    throw e;
  }
}

function threadCard(item){
  const answers = item.answersCount ?? (item.answers?.length || 0);
  const topics = (item.topics||[]).map(x=>`<span class="pill">${escapeHtml(x)}</span>`).join(' ');
  const locs   = (item.locations||[]).map(x=>`<span class="pill">${escapeHtml(x)}</span>`).join(' ');
  const qid = item.questionId || '';
  return `<div class="thread card">
    <div class="votes"><div style="font-size:18px; font-weight:800">${answers}</div><div class="hint">answers</div></div>
    <div style="flex:1">
      <div class="title">${escapeHtml(item.title||'(no title)')}</div>
      <div style="margin:6px 0">${escapeHtml(item.body||'')}</div>
      <div class="row">${topics || '<span class="pill">-</span>'}</div>
      <div style="height:6px"></div>
      <div class="row">${locs || '<span class="pill">-</span>'}</div>
      <div class="meta" style="margin-top:6px">ID: ${escapeHtml(qid)}</div>
      ${answers > 0 ? `<button class="btn" style="margin-top:8px" onclick="event.stopPropagation(); toggleAnswers('${escapeHtml(qid)}')">‡∏î‡∏π‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö (${answers})</button>` : ''}
      <div id="answers-${escapeHtml(qid)}" style="display:none; margin-top:12px; padding-top:12px; border-top:1px solid var(--border); grid-column:1/-1"></div>
    </div>
    <div class="meta">${escapeHtml(item.createdAt||'')}</div>
  </div>`;
}

function tokenize(s){ return (s||'').toLowerCase().normalize('NFKC').replace(/[^\p{L}\p{N}]+/gu,' ').trim().split(/\s+/).filter(Boolean); }
function levenshtein1orLess(a,b){
  if(a===b) return true; const la=a.length, lb=b.length; if(Math.abs(la-lb)>1) return false;
  let i=0,j=0,d=0; while(i<la && j<lb){ if(a[i]===b[j]){i++;j++;} else { if(++d>1) return false; if(la>lb)i++; else if(lb>la)j++; else {i++;j++;}} } return true;
}
function scoreItem(qTokens, item){
  const text=`${item.title||''} ${item.body||''} ${(item.topics||[]).join(' ')} ${(item.locations||[]).join(' ')}`;
  const toks=tokenize(text); const set=new Set(toks);
  let hit=0,tf=0,fz=0;
  for(const qt of qTokens){
    if(set.has(qt)){ hit++; tf+=toks.filter(t=>t===qt).length; continue; }
    const pref=toks.some(t=> t.startsWith(qt)&&qt.length>=3); if(pref){ fz+=.5; continue; }
    if(qt.length<=4) for(const t of toks){ if(Math.abs(t.length-qt.length)<=1 && levenshtein1orLess(t,qt)){ fz+=.4; break; } }
  }
  const titleBoost=(item.title||'').toLowerCase().includes(qTokens[0]||'') ? 1 : 0;
  return hit*2 + Math.min(tf,3)*.6 + fz + titleBoost;
}
function rankByQuery(items,q){ const qTokens=tokenize(q); if(!qTokens.length) return items.slice(); return items.map(x=>({x,s:scoreItem(qTokens,x)})).sort((a,b)=>b.s-a.s).map(o=>o.x); }

// ===== Modal handling =====
function showModal(modalId) {
  $('authModals').classList.add('show');
  $('signupCard').style.display = modalId === 'signup' ? 'block' : 'none';
  $('loginCard').style.display = modalId === 'login' ? 'block' : 'none';
  $('signupError').textContent = '';
  $('loginError').textContent = '';
}

function hideModal() {
  $('authModals').classList.remove('show');
  $('signupCard').style.display = 'none';
  $('loginCard').style.display = 'none';
}

// ===== UI wiring: Modals =====
$('openSignup').onclick = () => showModal('signup');
$('openLogin').onclick  = () => showModal('login');
$('cancelSignup').onclick = hideModal;
$('cancelLogin').onclick  = hideModal;

// Close modal when clicking backdrop
$('authModals').onclick = (e) => {
  if(e.target === $('authModals')) hideModal();
};

// ===== Auth buttons =====
$('doSignup').onclick = async ()=>{
  const btn = $('doSignup');
  btn.disabled = true;
  $('signupError').textContent = '';
  
  try{
    await signup($('su_user').value.trim(), $('su_pass').value);
    hideModal(); 
    renderAuth(); 
    toast('‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡πÅ‡∏•‡∏∞‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡πÅ‡∏•‡πâ‡∏ß','ok');
    $('su_user').value = '';
    $('su_pass').value = '';
  }catch(e){ 
    $('signupError').textContent = e.message || '‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à';
  } finally {
    btn.disabled = false;
  }
};

$('doLogin').onclick  = async ()=>{
  const btn = $('doLogin');
  btn.disabled = true;
  $('loginError').textContent = '';
  
  try{
    await login($('li_user').value.trim(), $('li_pass').value);
    hideModal(); 
    renderAuth(); 
    toast('‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡πÅ‡∏•‡πâ‡∏ß','ok');
    $('li_user').value = '';
    $('li_pass').value = '';
  }catch(e){ 
    $('loginError').textContent = e.message || '‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à';
  } finally {
    btn.disabled = false;
  }
};

$('logoutBtn').onclick = ()=>{ logout(); renderAuth(); toast('‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö‡πÅ‡∏•‡πâ‡∏ß','ok'); };

// ===== Search / Latest =====
$('doSearch').onclick = async ()=>{
  const q=$('q').value.trim(); const box=$('results'); box.innerHTML=''; const sk=skeleton(box);
  try{
    const list = await fetchQuestions();
    const ranked = q ? rankByQuery(list, q) : list;
    box.innerHTML = ranked.length ? ranked.map(threadCard).join('') : '<span class="hint">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå</span>';
  }catch(e){
    console.error(e); 
    box.innerHTML='<span class="hint">‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ' + escapeHtml(e.message) + '</span>'; 
    toast('Search error: ' + e.message, 'err');
  } finally { sk?.remove?.(); }
};

$('latest').onclick = async ()=>{
  const out=$('latestOut'); out.innerHTML=''; const sk=skeleton(out);
  try{
    const list = await fetchQuestions();
    console.log('Loaded questions:', list); // Debug: see what we got
    $('latestCount').textContent = list.length ? `${list.length} ‡∏Å‡∏£‡∏∞‡∏ó‡∏π‡πâ` : '';
    out.innerHTML = list.length ? list.map(threadCard).join('') : '<span class="hint">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Å‡∏£‡∏∞‡∏ó‡∏π‡πâ</span>';
  }catch(e){
    console.error(e); 
    out.innerHTML='<span class="hint">‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ' + escapeHtml(e.message) + '</span>'; 
    toast('Load error: ' + e.message, 'err');
  } finally { sk?.remove?.(); }
};

// ===== Ask / Answer =====
$('ask').onclick = async ()=>{
  if(!getSession()){ toast('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤ Login ‡∏Å‡πà‡∏≠‡∏ô','err'); return; }
  const title=$('title').value.trim(); const body=$('body').value.trim();
  if(!title){ toast('‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏£‡∏≠‡∏Å‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠','err'); return; }
  
  const btn = $('ask');
  btn.disabled = true;
  
  try{
    const r = await fetch(api + '/questions', {
      method:'POST',
      headers:{ 'Content-Type':'application/json', ...authHeader() },
      body: JSON.stringify({ title, body })
    });
    if(!r.ok) throw new Error('HTTP ' + r.status);
    const data = await r.json().catch(()=>({}));
    // API returns {status:'ok', questionId:'q-xxx'}
    if(data.status !== 'ok'){ 
      toast(data?.error || '‡πÇ‡∏û‡∏™‡∏ï‡πå‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à','err'); 
      return; 
    }
    const qid = data.questionId || '(unknown)';
    $('askOut').textContent = `Question ID: ${qid}`;
    $('title').value=''; $('body').value='';
    toast('‡πÇ‡∏û‡∏™‡∏ï‡πå‡πÅ‡∏•‡πâ‡∏ß ‚úÖ','ok');
    // Auto refresh
    setTimeout(() => $('latest').click(), 300);
  }catch(e){ 
    console.error(e); 
    toast('Network error: ' + e.message, 'err'); 
  } finally {
    btn.disabled = false;
  }
};

$('answer').onclick = async ()=>{
  if(!getSession()){ toast('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤ Login ‡∏Å‡πà‡∏≠‡∏ô','err'); return; }
  const qid=$('qid').value.trim(); const body=$('ans').value.trim();
  if(!qid || !body){ toast('‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏£‡∏≠‡∏Å Question ID ‡πÅ‡∏•‡∏∞‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö','err'); return; }
  
  const btn = $('answer');
  btn.disabled = true;
  
  try{
    const r = await fetch(api + `/questions/${encodeURIComponent(qid)}/answers`, {
      method:'POST',
      headers:{ 'Content-Type':'application/json', ...authHeader() },
      body: JSON.stringify({ body })
    });
    if(!r.ok) throw new Error('HTTP ' + r.status);
    const data = await r.json().catch(()=>({}));
    // API returns {answerId:'a-xxx'}
    const aid = data.answerId || '(unknown)';
    $('ansOut').textContent = 'Answer ID: ' + aid;
    $('ans').value=''; $('qid').value='';
    toast('‡∏ï‡∏≠‡∏ö‡πÅ‡∏•‡πâ‡∏ß üí¨','ok');
    // Clear cache and auto refresh
    answersCache.clear();
    setTimeout(() => $('latest').click(), 500);
  }catch(e){ 
    console.error(e); 
    toast('Network error: ' + e.message, 'err'); 
  } finally {
    btn.disabled = false;
  }
};

// Enter key support
$('li_pass').addEventListener('keypress', (e) => {
  if(e.key === 'Enter') $('doLogin').click();
});
$('su_pass').addEventListener('keypress', (e) => {
  if(e.key === 'Enter') $('doSignup').click();
});
$('q').addEventListener('keypress', (e) => {
  if(e.key === 'Enter') $('doSearch').click();
});

// ===== Toggle Answers Display =====
const answersCache = new Map();

async function fetchAnswersForQuestion(qid) {
  if(answersCache.has(qid)) return answersCache.get(qid);
  
  try {
    // Fetch answers directly from /answers endpoint
    const r = await fetch(api + '/answers');
    if(!r.ok) throw new Error('Failed to load answers');
    
    const allAnswers = await r.json().catch(() => []);
    
    // Filter answers for this specific question
    const answers = Array.isArray(allAnswers) ? 
      allAnswers.filter(a => a.questionId === qid) : [];
    
    console.log('Fetched answers for', qid, ':', answers); // Debug log
    
    answersCache.set(qid, answers);
    return answers;
  } catch(e) {
    console.error('fetchAnswers error:', e);
    return [];
  }
}

window.toggleAnswers = async function(qid) {
  const container = document.getElementById(`answers-${qid}`);
  if(!container) {
    console.error('Container not found for qid:', qid);
    return;
  }
  
  // Toggle visibility
  if(container.style.display === 'block') {
    container.style.display = 'none';
    return;
  }
  
  container.style.display = 'block';
  container.innerHTML = '<div class="skeleton"></div>';
  
  try {
    const answers = await fetchAnswersForQuestion(qid);
    
    console.log('Displaying', answers.length, 'answers for', qid); // Debug log
    
    if(answers.length === 0) {
      container.innerHTML = '<div class="hint">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö</div>';
      return;
    }
    
    container.innerHTML = answers.map(a => `
      <div style="padding:12px; background:var(--bg); border-radius:8px; margin-bottom:8px">
        <div style="font-size:14px; line-height:1.6">${escapeHtml(a.body || '')}</div>
        <div class="meta" style="margin-top:6px">
          ‡πÇ‡∏î‡∏¢ @${escapeHtml(a.author || 'anon')} ‚Ä¢ ${escapeHtml(a.createdAt || '')}
        </div>
      </div>
    `).join('');
    
  } catch(e) {
    console.error('toggleAnswers error:', e);
    container.innerHTML = '<div class="hint" style="color:#ef4444">‡πÇ‡∏´‡∏•‡∏î‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ' + escapeHtml(e.message) + '</div>';
  }
};

window.addEventListener('load', () => {
  renderAuth();
  // Auto-load questions on page load
  $('latest').click();
});
</script>
</body>
</html>
