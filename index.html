<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <title>Kumpee Bangkok ‚Ä¢ Webboard (Single-file)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="color-scheme" content="light dark" />
  <!-- Google Identity Services (Google Sign-In) -->
  <script src="https://accounts.google.com/gsi/client" async defer></script>
  <style>
    :root{ --bg:#f7f8fb; --card:#fff; --border:#e5e7eb; --text:#0f172a; --muted:#6b7280; --ring:#818cf8; --acc1:#6366f1; --acc2:#22c55e; --shadow:0 10px 24px rgba(2,6,23,.12) }
    @media (prefers-color-scheme: dark){ :root{ --bg:#0b1220; --card:#0f172a; --border:#1f2937; --text:#e5e7ee; --muted:#9aa3b2; --shadow:0 10px 24px rgba(0,0,0,.45) } }
    *{box-sizing:border-box}
    body{
      margin:0; font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Arial; color:var(--text);
      background:
        radial-gradient(900px 500px at -10% -10%, rgba(99,102,241,.16), transparent 60%),
        radial-gradient(900px 500px at 110% 0%, rgba(34,197,94,.16), transparent 60%),
        var(--bg)
    }
    a{color:inherit}
    .hero{position:sticky; top:0; z-index:10; backdrop-filter: blur(8px); border-bottom:1px solid var(--border); background:linear-gradient(135deg, rgba(99,102,241,.10), rgba(34,197,94,.08)), color-mix(in srgb, #fff 85%, transparent)}
    .hero-inner{max-width:1000px; margin:0 auto; padding:14px 16px; display:flex; align-items:center; gap:12px}
    .logo{display:grid; place-items:center; width:42px; height:42px; border-radius:12px; color:#fff; background:linear-gradient(145deg, var(--acc1), var(--acc2)); box-shadow:var(--shadow)}
    .brand{flex:1}
    .brand h1{margin:0; font-size:18px}
    .brand p{margin:0; color:var(--muted); font-size:12px}
    .wrap{max-width:1000px; margin:18px auto; padding:0 16px; display:grid; gap:16px}
    @media (min-width: 900px){ .wrap{grid-template-columns: 2fr 1fr} }
    .card{background:var(--card); border:1px solid var(--border); border-radius:14px; padding:16px; box-shadow:var(--shadow)}
    .card h3{margin:0 0 10px}
    label{font-size:12px; color:var(--muted); display:block; margin-bottom:6px}
    input, textarea{width:100%; padding:10px 12px; border:1px solid var(--border); border-radius:10px; background:transparent; color:inherit; outline:none}
    input:focus, textarea:focus{border-color:var(--ring); box-shadow:0 0 0 3px color-mix(in srgb, var(--ring) 30%, transparent)}
    .row{display:flex; align-items:center; gap:8px; flex-wrap:wrap}
    .btn{appearance:none; border:1px solid var(--border); background:#f8fafc; padding:8px 12px; border-radius:10px; cursor:pointer; font-weight:600}
    .btn-primary{background:linear-gradient(135deg, var(--acc1), var(--acc2)); color:#fff; border:none}
    .btn-ghost{background:transparent}
    .hint{color:var(--muted); font-size:12px}
    .pill{display:inline-block; padding:.18rem .5rem; border:1px solid var(--border); border-radius:999px; font-size:12px; color:var(--muted)}
    .list{display:grid; gap:12px}
    .thread{display:grid; grid-template-columns:auto 1fr auto; gap:10px; align-items:center}
    .votes{display:grid; place-items:center; padding:8px; border:1px solid var(--border); border-radius:10px; min-width:56px}
    .title{font-weight:700}
    .meta{color:var(--muted); font-size:12px}
    .searchbar{display:flex; gap:8px}
    .searchbar input{flex:1}
    .toast{position:fixed; right:16px; bottom:16px; display:grid; gap:8px; z-index:50}
    .t{padding:10px 12px; border-radius:12px; background:#0b1220; color:#eef2ff; border:1px solid #293249; box-shadow:var(--shadow)}
    .t.ok{background:#052816; color:#ecfdf5}
    .t.err{background:#2a0b0b; color:#fee2e2}
    .skeleton{height:64px; border-radius:12px; background:linear-gradient(90deg, rgba(148,163,184,.16), rgba(148,163,184,.06), rgba(148,163,184,.16)); background-size:200% 100%; animation:shim 1.2s infinite}
    @keyframes shim{0%{background-position:200% 0}100%{background-position:-200% 0}}
  </style>
</head>
<body>
  <header class="hero">
    <div class="hero-inner">
      <div class="logo">KB</div>
      <div class="brand">
        <h1>Kumpee Bangkok ‚Ä¢ Webboard</h1>
        <p>‡∏ñ‡∏≤‡∏°-‡∏ï‡∏≠‡∏ö‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏ä‡∏µ‡∏ß‡∏¥‡∏ï‡πÉ‡∏ô‡∏Å‡∏£‡∏∏‡∏á‡πÄ‡∏ó‡∏û‡∏Ø ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÅ‡∏ö‡∏ö‡∏à‡∏±‡∏î‡∏≠‡∏±‡∏ô‡∏î‡∏±‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Ç‡πâ‡∏≠‡∏á</p>
      </div>
      <div class="row">
        <!-- Google Sign-In button -->
        <div id="g_id_signin"></div>
        <!-- Cognito Hosted UI fallback -->
        <button id="loginHosted" class="btn">Sign in via Cognito</button>
        <span id="who" class="hint" aria-live="polite"></span>
      </div>
    </div>
  </header>

  <main class="wrap">
    <section>
      <div class="card">
        <h3>üîé ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°</h3>
        <div class="searchbar">
          <input id="q" placeholder="‡πÄ‡∏ä‡πà‡∏ô: ‡∏ß‡∏µ‡∏ã‡πà‡∏≤‡∏ó‡∏µ‡πà‡πÄ‡∏Ç‡∏ï‡∏ö‡∏≤‡∏á‡∏£‡∏±‡∏Å / ‡∏°.‡∏Å‡∏£‡∏∏‡∏á‡πÄ‡∏ó‡∏û ‡∏´‡∏≠‡∏û‡∏±‡∏Å" />
          <button id="doSearch" class="btn btn-primary">Search</button>
        </div>
        <div class="hint" style="margin-top:6px">‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡∏à‡∏±‡∏î‡∏≠‡∏±‡∏ô‡∏î‡∏±‡∏ö‡∏î‡πâ‡∏ß‡∏¢ keyword + TF + fuzzy (prefix & ‡πÅ‡∏Å‡πâ‡∏ï‡πà‡∏≤‡∏á ‚â§ 1 ‡∏ï‡∏±‡∏ß‡∏≠‡∏±‡∏Å‡∏©‡∏£) + title boost</div>
        <div id="results" class="list" style="margin-top:12px"></div>
      </div>

      <div class="card">
        <h3>üßµ ‡∏Å‡∏£‡∏∞‡∏ó‡∏π‡πâ‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î</h3>
        <div class="row">
          <button id="latest" class="btn">‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</button>
          <span id="latestCount" class="hint"></span>
        </div>
        <div id="latestOut" class="list" style="margin-top:12px"></div>
      </div>
    </section>

    <aside>
      <div class="card">
        <h3>‚ùì ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Å‡∏£‡∏∞‡∏ó‡∏π‡πâ‡πÉ‡∏´‡∏°‡πà</h3>
        <label class="hint">‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠</label>
        <input id="title" placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏™‡∏±‡πâ‡∏ô ‡πÜ" />
        <div style="height:8px"></div>
        <label class="hint">‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î</label>
        <textarea id="body" rows="5" placeholder="‡πÄ‡∏•‡πà‡∏≤‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î ‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà ‡πÄ‡∏ß‡∏•‡∏≤ ‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Ç‡πâ‡∏≠‡∏á ‡∏Ø‡∏•‡∏Ø"></textarea>
        <div class="row" style="margin-top:10px">
          <button id="ask" class="btn btn-primary">‡πÇ‡∏û‡∏™‡∏ï‡πå‡∏Å‡∏£‡∏∞‡∏ó‡∏π‡πâ</button>
          <span class="hint">‡∏ï‡πâ‡∏≠‡∏á Sign in ‡∏Å‡πà‡∏≠‡∏ô</span>
        </div>
        <div id="askOut" class="hint" style="margin-top:8px"></div>
      </div>

      <div class="card">
        <h3>üí¨ ‡∏ï‡∏≠‡∏ö‡∏Å‡∏£‡∏∞‡∏ó‡∏π‡πâ</h3>
        <label class="hint">Question ID</label>
        <input id="qid" placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡πÑ‡∏≠‡∏î‡∏µ‡∏Å‡∏£‡∏∞‡∏ó‡∏π‡πâ" />
        <div style="height:8px"></div>
        <label class="hint">‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì</label>
        <textarea id="ans" rows="4" placeholder="‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢‡πÉ‡∏´‡πâ‡∏ä‡∏±‡∏î‡πÄ‡∏à‡∏ô ‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÅ‡∏´‡∏•‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ñ‡πâ‡∏≤‡∏°‡∏µ"></textarea>
        <div class="row" style="margin-top:10px">
          <button id="answer" class="btn btn-primary">‡πÇ‡∏û‡∏™‡∏ï‡πå‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö</button>
        </div>
        <div id="ansOut" class="hint" style="margin-top:8px"></div>
      </div>
    </aside>
  </main>

  <div class="toast" id="toast" aria-live="polite" aria-atomic="true"></div>

<script>
// ===================== Config =====================
const region = "us-east-1";
const userPoolId = "YOUR_USER_POOL_ID";                   // ‡πÉ‡∏ä‡πâ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏° Cognito
const clientId   = "YOUR_CLIENT_ID";
const domain     = `https://YOUR_COGNITO_DOMAIN.auth.${region}.amazoncognito.com`;
const api        = "YOUR_API_URL";                        // e.g., https://abc123.execute-api.us-east-1.amazonaws.com
const redirectUri= window.location.origin + window.location.pathname;

// ‡∏ñ‡πâ‡∏≤‡∏à‡∏∞‡πÉ‡∏ä‡πâ Google ‡πÇ‡∏î‡∏¢‡∏ï‡∏£‡∏á ‡πÉ‡∏´‡πâ‡πÉ‡∏™‡πà Client ID ‡∏à‡∏£‡∏¥‡∏á (‡∏à‡∏≤‡∏Å Google Cloud)
const GOOGLE_CLIENT_ID = "YOUR_GOOGLE_CLIENT_ID.apps.googleusercontent.com";

// ===================== Utilities ==================
let idToken = null;     // ‡πÄ‡∏Å‡πá‡∏ö JWT ‡∏à‡∏≤‡∏Å Google ‡∏´‡∏£‡∏∑‡∏≠ Cognito
function $(id){ return document.getElementById(id); }
function parseHash(h){ const p=new URLSearchParams(h.replace(/^#/,"")); return Object.fromEntries(p.entries()); }
function toast(msg, kind='ok'){ const t=document.createElement('div'); t.className=`t ${kind}`; t.textContent=msg; $('toast').appendChild(t); setTimeout(()=>{t.style.opacity='0'; t.style.transform='translateY(6px)'},2300); setTimeout(()=>t.remove(),3000); }
function skeleton(parent){ const s=document.createElement('div'); s.className='skeleton'; parent.appendChild(s); return s; }
function escapeHtml(s){ return String(s).replace(/[&<>\"']/g, m=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"}[m])); }

// ===================== Webboard UI ==================
function threadCard(item){
  const answers = item.answersCount ?? (item.answers?.length || 0);
  const topics = (item.topics||[]).map(x=>`<span class="pill">${escapeHtml(x)}</span>`).join(' ');
  const locs   = (item.locations||[]).map(x=>`<span class="pill">${escapeHtml(x)}</span>`).join(' ');
  return `<div class="thread card">
    <div class="votes"><div style="font-size:18px; font-weight:800">${answers}</div><div class="hint">answers</div></div>
    <div>
      <div class="title">${escapeHtml(item.title||'(no title)')}</div>
      <div style="margin:6px 0">${escapeHtml(item.body||'')}</div>
      <div class="row">${topics || '<span class="pill">-</span>'}</div>
      <div style="height:6px"></div>
      <div class="row">${locs || '<span class="pill">-</span>'}</div>
      <div class="meta" style="margin-top:6px">ID: ${escapeHtml(item.questionId||'')}</div>
    </div>
    <div class="meta">${escapeHtml(item.createdAt||'')}</div>
  </div>`;
}

// ===================== Search Ranking ==================
// Hybrid score = token overlap + TF + fuzzy (prefix / edit<=1) + title boost
function tokenize(s){
  return (s||'')
    .toLowerCase()
    .normalize('NFKC')
    // ‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡πÑ‡∏ó‡∏¢‡πÅ‡∏•‡∏∞‡∏ï‡∏±‡∏ß‡∏≠‡∏±‡∏Å‡∏©‡∏£‡∏¢‡∏π‡∏ô‡∏¥‡πÇ‡∏Ñ‡πâ‡∏î‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ
    .replace(/[^\p{L}\p{N}]+/gu,' ')
    .trim()
    .split(/\s+/)
    .filter(Boolean);
}
function levenshtein1orLess(a,b){
  if(a===b) return true;
  const la=a.length, lb=b.length;
  if(Math.abs(la-lb)>1) return false;
  let i=0,j=0,diff=0;
  while(i<la && j<lb){
    if(a[i]===b[j]){ i++; j++; }
    else{
      diff++; if(diff>1) return false;
      if(la>lb) i++; else if(lb>la) j++; else { i++; j++; }
    }
  }
  return true;
}
function scoreItem(qTokens, item){
  const text = `${item.title||''} ${item.body||''} ${(item.topics||[]).join(' ')} ${(item.locations||[]).join(' ')}`;
  const toks = tokenize(text);
  const set  = new Set(toks);
  let hit=0, tf=0, fuzzy=0;
  for(const qt of qTokens){
    if(set.has(qt)){ hit++; tf += toks.filter(t=>t===qt).length; continue; }
    const pref = toks.some(t=> t.startsWith(qt) && qt.length>=3);
    if(pref) { fuzzy += .5; continue; }
    if(qt.length<=4){
      for(const t of toks){ if(Math.abs(t.length-qt.length)<=1 && levenshtein1orLess(t,qt)){ fuzzy += .4; break; } }
    }
  }
  const titleBoost = (item.title||'').toLowerCase().includes(qTokens[0]||'') ? 1 : 0;
  return hit*2 + Math.min(tf,3)*0.6 + fuzzy + titleBoost;
}
function rankByQuery(items, q){
  const qTokens = tokenize(q);
  if(!qTokens.length) return items;
  return items.map(x=>({x, s: scoreItem(qTokens,x)})).sort((a,b)=>b.s-a.s).map(o=>o.x);
}

// ===================== Auth =====================
// Google (single-file)
window.handleGoogleCred = (resp)=>{
  try{
    idToken = resp.credential; // Google ID Token (JWT)
    $('who').textContent = 'Signed in with Google ‚úîÔ∏è';
    toast('Signed in with Google','ok');
  }catch(e){ console.error(e); toast('Google Sign-In failed','err'); }
};

// Cognito Hosted UI
$('loginHosted').onclick = ()=>{
  const url = `${domain}/login?client_id=${clientId}&response_type=token&scope=email+openid&redirect_uri=${encodeURIComponent(redirectUri)}`;
  location = url;
};
// Handle Cognito redirect
(function initCognito(){
  if (location.hash.includes('id_token=')){
    const params = parseHash(location.hash);
    idToken = params.id_token; // Cognito id_token
    $('who').textContent = 'Signed in ‚úîÔ∏è';
    history.replaceState({}, document.title, redirectUri);
    toast('Signed in','ok');
  }
})();
// Render Google button after library load
window.onload = function(){
  if(window.google && window.google.accounts && GOOGLE_CLIENT_ID !== 'YOUR_GOOGLE_CLIENT_ID.apps.googleusercontent.com'){
    google.accounts.id.initialize({ client_id: GOOGLE_CLIENT_ID, callback: handleGoogleCred });
    google.accounts.id.renderButton(document.getElementById('g_id_signin'), { theme: 'outline', size: 'large', type:'standard', shape:'pill' });
  } else {
    const b = document.getElementById('g_id_signin'); if(b) b.style.display='none';
  }
};

function authHeader(){
  return idToken ? { 'Authorization': `Bearer ${idToken}` } : {};
}

// ===================== Actions ==================
$('doSearch').onclick = async ()=>{
  const q = $('q').value.trim();
  const box = $('results'); box.innerHTML='';
  skeleton(box);
  try{
    const r = await fetch(api + '/search?q=' + encodeURIComponent(q));
    if(!r.ok) throw new Error('Search failed');
    const arr = await r.json();
    const ranked = q ? rankByQuery(arr, q) : arr;
    box.innerHTML = ranked.length ? ranked.map(threadCard).join('') : '<span class="hint">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå</span>';
  }catch(e){
    console.error(e); box.innerHTML = '<span class="hint">‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤</span>'; toast('Search error','err');
  }
};

$('latest').onclick = async ()=>{
  const out = $('latestOut'); out.innerHTML='';
  skeleton(out);
  try{
    const r = await fetch(api + '/questions');
    if(!r.ok) throw new Error('Load failed');
    const arr = await r.json();
    $('latestCount').textContent = arr.length ? `${arr.length} ‡∏Å‡∏£‡∏∞‡∏ó‡∏π‡πâ` : '';
    out.innerHTML = arr.length ? arr.map(threadCard).join('') : '<span class="hint">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Å‡∏£‡∏∞‡∏ó‡∏π‡πâ</span>';
  }catch(e){
    console.error(e); out.innerHTML = '<span class="hint">‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à</span>'; toast('Load error','err');
  }
};

$('ask').onclick = async ()=>{
  if(!idToken){ toast('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤ Sign in ‡∏Å‡πà‡∏≠‡∏ô','err'); return; }
  const title = $('title').value.trim();
  const body  = $('body').value.trim();
  if(!title){ toast('‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏£‡∏≠‡∏Å‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠','err'); return; }
  try{
    const r = await fetch(api + '/questions', {
      method:'POST',
      headers: { 'Content-Type':'application/json', ...authHeader() },
      body: JSON.stringify({ title, body })
    });
    const data = await r.json();
    $('askOut').textContent = `Status: ${data.status||r.status} | Question ID: ${data.questionId||''}`;
    if(r.ok){ $('title').value=''; $('body').value=''; toast('‡πÇ‡∏û‡∏™‡∏ï‡πå‡∏Å‡∏£‡∏∞‡∏ó‡∏π‡πâ‡πÅ‡∏•‡πâ‡∏ß ‚úÖ','ok'); }
    else toast('‡πÇ‡∏û‡∏™‡∏ï‡πå‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à','err');
  }catch(e){ console.error(e); toast('Network error','err'); }
};

$('answer').onclick = async ()=>{
  if(!idToken){ toast('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤ Sign in ‡∏Å‡πà‡∏≠‡∏ô','err'); return; }
  const qid = $('qid').value.trim();
  const body= $('ans').value.trim();
  if(!qid || !body){ toast('‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏£‡∏≠‡∏Å Question ID ‡πÅ‡∏•‡∏∞‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö','err'); return; }
  try{
    const r = await fetch(api + `/questions/${qid}/answers`, {
      method:'POST',
      headers:{ 'Content-Type':'application/json', ...authHeader() },
      body: JSON.stringify({ body })
    });
    const data = await r.json();
    $('ansOut').textContent = 'Answer ID: ' + (data.answerId || '');
    if(r.ok){ $('ans').value=''; toast('‡πÇ‡∏û‡∏™‡∏ï‡πå‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö‡πÅ‡∏•‡πâ‡∏ß üí¨','ok'); }
    else toast('‡πÇ‡∏û‡∏™‡∏ï‡πå‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à','err');
  }catch(e){ console.error(e); toast('Network error','err'); }
};
</script>
</body>
</html>
